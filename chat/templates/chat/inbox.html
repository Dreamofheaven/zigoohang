{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/chat/inbox.css' %}">
{% endblock head %}

{% block content %}
<section>
  <a href="{% url 'chat:start_chat' user.id %}"><h2>나와의 채팅하기</h2></a>
  <h2>사용자 목록</h2>
  <form method="post" action="{% url 'chat:start_group_chat' %}">
    {% csrf_token %}
    {% for user in all_users %}
      <input type="checkbox" name="user_ids" value="{{ user.id }}"> {{ user.username }}
    {% empty %}
      <p>다른 사용자가 없습니다.</p>
    {% endfor %}
    <input type="submit" value="채팅방 만들기">
  </form>
</section>
<section id="chat-rooms-section">
  {% if chat_rooms %}
    {% for chat_room, last_message, unread_notifications in chat_rooms %}
      <div class="chat_room" id="{{ chat_room.name }}" value="{{ chat_room.name }}">
        <a href="{% url 'chat:room' chat_room.name %}" style="margin-right: 0.5rem;" id="room_name">{{ chat_room }}</a>
        {% if unread_notifications > 0 %}
          <p class="notification" style="color: red">!</p>
          <p class="unread_count">{{ unread_notifications }}</p>
        {% endif %}
        {% if last_message %}
          <p class="last-message">{{ last_message.content }}</p>
          <p class="last-message">{{ last_message.formatted_timestamp }}</p>
        {% else %}
          <p class="last-message">메시지 없음</p>
          <p class="timestamp"></p>
        {% endif %}
        <form action="{% url 'chat:delete_chat' room_name=chat_room.name %}" method="post">
          {% csrf_token %}
          <input type="submit" value="삭제">
        </form>
      </div>
    {% endfor %}
  {% else %}
    <p>채팅방이 없습니다.</p>
  {% endif %}
</section>
{% endblock content %}

{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  function updateNotificationsAndLastMessages() {
    $.ajax({
      url: "{% url 'chat:get_notifications' %}",
      type: "GET",
      dataType: "json",
      success: function (data) {
        data.notifications.forEach(function (notification) {
          var chatRoomId = notification.chat_room_id;
          var unreadNotifications = notification.unread_notifications;
          var chatRoomElement = $("#" + chatRoomId);
          var notificationElement = chatRoomElement.find(".notification");
          var unreadCountElement = chatRoomElement.find(".unread_count");

          if (unreadNotifications > 0) {
            notificationElement.show();
            unreadCountElement.text(unreadNotifications);
          } else {
            notificationElement.hide();
            unreadCountElement.text("");
          }
        });

        data.last_messages.forEach(function (lastMessage) {
          var chatRoomId = lastMessage.chat_room_id;
          var lastMessageContent = lastMessage.last_message;
          var timestamp = lastMessage.timestamp;
          var chatRoomElement = $("#" + chatRoomId);
          var lastMessageElement = chatRoomElement.find(".last-message");
          var timestampElement = chatRoomElement.find(".timestamp");

          lastMessageElement.text(lastMessageContent);
          timestampElement.text(timestamp);
        });
      },
      error: function (xhr, status, error) {
        console.log(error);
      }
    });
  }

  // Update notifications and last messages every 5 seconds
  {% comment %} setInterval(updateNotificationsAndLastMessages, 5000); {% endcomment %}

  // Initial update
  updateNotificationsAndLastMessages();
</script>
{% endblock script %}