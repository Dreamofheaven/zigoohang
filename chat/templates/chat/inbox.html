{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/chat/inbox.css' %}">
{% endblock head %}

{% block content %}
<section>
  <a href="{% url 'chat:start_chat' user.id %}"><h2>나와의 채팅하기</h2></a>
  <h2>사용자 목록</h2>
  <form method="post" action="{% url 'chat:start_group_chat' %}">
    {% csrf_token %}
    {% for user in all_users %}
      <input type="checkbox" name="user_ids" value="{{ user.id }}"> {{ user.username }}
    {% empty %}
      <p>다른 사용자가 없습니다.</p>
    {% endfor %}
    <input type="submit" value="채팅방 만들기">
  </form>
</section>
<section id="chat-rooms-section">
  {% if chat_rooms %}
    {% for chat_room, last_message, unread_notifications in chat_rooms %}
      <div class="chat_room" id="{{ chat_room.name }}">
        <a href="{% url 'chat:room' chat_room.name %}" style="margin-right: 0.5rem;">{{ chat_room }}</a>
        {% if unread_notifications > 0 %}
          <p class="notification" style="color: red">!</p>
        {% endif %}
        {% if last_message %}
          <p class="last-message">{{ last_message.content }}</p>
          <p class="last-message">{{ last_message.formatted_timestamp }}</p>
        {% else %}
          <p class="last-message">메시지 없음</p>
          <p class="timestamp"></p>
        {% endif %}
        <form action="{% url 'chat:delete_chat' room_name=chat_room.name %}" method="post">
          {% csrf_token %}
          <input type="submit" value="삭제">
        </form>
      </div>
    {% endfor %}
  {% else %}
    <p>채팅방이 없습니다.</p>
  {% endif %}
</section>
{% endblock content %}

{% block script %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let loc = window.location;
    let wsStart = 'ws://';
    if (loc.protocol == 'https:') {
      wsStart = 'wss://';
    }

    const notificationSocket = new WebSocket(
      wsStart + window.location.host + '/ws/chat/notifications/'
    );
    console.log(notificationSocket)

    notificationSocket.onopen = function (event) {
      console.log('WebSocket connection established.');
    };

    notificationSocket.onmessage = function (event) {
      console.log(event.data)
      const messageData = JSON.parse(event.data);
      console.log('Received notification:', messageData);
      updateNotificationCount(messageData.room_name);
      updateChatRooms(messageData);
    };

    notificationSocket.onclose = function (event) {
      console.log('WebSocket connection closed.');
    };

    notificationSocket.onerror = function (event) {
      console.error('WebSocket error:', event);
    };

    function updateNotificationCount(room_name) {
      const chatRoomElement = document.getElementById(room_name);
      const notificationElement = chatRoomElement.querySelector('.notification');
      
      if (notificationElement) {
        notificationElement.style.display = 'block';
      }
    }

    function updateChatRooms(messageData) {
      const chatRoomElement = document.getElementById(messageData.room_name);
  
      if (chatRoomElement) {
        const lastMessageElement = chatRoomElement.querySelector('.last-message');
        const timestampElement = chatRoomElement.querySelector('.timestamp');
  
        if (lastMessageElement && timestampElement) {
          lastMessageElement.textContent = messageData.message;
          timestampElement.textContent = messageData.formatted_timestamp;
        }
      } else {
        const chatRoomsSection = document.getElementById('chat-rooms-section');
        const newChatRoom = document.createElement('div');
        newChatRoom.classList.add('chat_room');
        newChatRoom.id = messageData.room_name;
        newChatRoom.innerHTML = `
          <a href="/chat/room/${messageData.room_name}/" style="margin-right: 0.5rem;">${messageData.room_name}</a>
          <p class="last-message">${messageData.message}</p>
          <p class="timestamp">${messageData.formatted_timestamp}</p>
          <form action="/chat/delete/${messageData.room_name}/" method="post">
            {% csrf_token %}
            <input type="submit" value="삭제">
          </form>
        `;
        chatRoomsSection.appendChild(newChatRoom);
      }
    }
  });
</script>
{% endblock script %}