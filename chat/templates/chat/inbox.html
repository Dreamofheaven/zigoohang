{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/chat/inbox.css' %}">
{% endblock head %}

{% block content %}
<section>
  <a href="{% url 'chat:start_chat' user.id %}"><h2>나와의 채팅하기</h2></a>
  <h2>사용자 목록</h2>
  <form method="post" action="{% url 'chat:start_group_chat' %}">
    {% csrf_token %}
    {% for user in all_users %}
      <input type="checkbox" name="user_ids" value="{{ user.id }}"> {{ user.username }}
    {% empty %}
      <p>다른 사용자가 없습니다.</p>
    {% endfor %}
    <input type="submit" value="채팅방 만들기">
  </form>
</section>
<section id="chat-rooms-section">
  {% if chat_rooms %}
    {% for chat_room, last_message, unread_notifications in chat_rooms %}
      <div class="chat_room" id="{{ chat_room.name }}" value="{{ chat_room.pk }}">
        <a href="{% url 'chat:room' chat_room.name %}" style="margin-right: 0.5rem;" id="room_name">{{ chat_room }}</a>
        <p class="notification notification--color noti">!</p>
        <p class="unread_count noti">{{ unread_notifications }}</p>
        {% if last_message %}
          <p class="last-message">{{ last_message.content }}</p>
          <p class="timestamp">{{ last_message.formatted_timestamp }}</p>
        {% else %}
          <p class="last-message">메시지 없음</p>
          <p class="timestamp"></p>
        {% endif %}
        <form action="{% url 'chat:delete_chat' room_name=chat_room.name %}" method="post">
          {% csrf_token %}
          <input type="submit" value="삭제">
        </form>
      </div>
    {% endfor %}
  {% else %}
    <p>채팅방이 없습니다.</p>
  {% endif %}
</section>
{% endblock content %}

{% block script %}
<script>
  function updateNotificationData() {
    fetch("{% url 'chat:unread_notifications' %}")
      .then(response => response.json())
      .then(data => {
        data.data.forEach(chat_room_data => {
          console.log(chat_room_data)
          let chat_room_div = document.getElementById(chat_room_data.room_name);
          console.log(chat_room_div)
          let notification = chat_room_div.querySelector(".notification");
          console.log(notification)
          let unread_count = chat_room_div.querySelector(".unread_count");
          console.log(unread_count)
          let last_message = chat_room_div.querySelector(".last-message");
          console.log(last_message)
          let timestamp = chat_room_div.querySelector(".timestamp");
          console.log(timestamp)

          if (chat_room_data.unread_notifications > 0) {
            notification.classList.remove("noti")
            unread_count.classList.remove("noti")
            unread_count.textContent = chat_room_data.unread_notifications;
          }

          last_message.textContent = chat_room_data.last_message;
          timestamp.textContent = chat_room_data.last_message_timestamp;
        });
      });
  }
  updateNotificationData();
  {% comment %} setInterval(updateNotificationData, 5000); {% endcomment %}
</script>
{% endblock script %}

{% comment %} 5초마다 정보 받아옴 {% endcomment %}
{% comment %} setInterval(updateNotificationData, 5000); {% endcomment %}