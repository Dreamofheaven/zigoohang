{% extends "base.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/challenges/detail.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
{% endblock head %}

{% block content %}
<br>
<h1>{{ challenge.title }}</h1>
<br>
<p>{{ challenge.description }}</p>

<div class="challenge-image-container">
    {% for image in challenge_images %}
    <div class="challenge-image">
        <img src="{{ image.image.url }}" alt="">

        {% if ended %}
        <div class="ended-overlay">
            <span>종료된 캠페인입니다.</span>
        </div>
        {% endif %}
    </div>
    {% empty %}
        <p>이미지가 없습니다.</p>
    {% endfor %}
</div>
{% if request.user == challenge.creator %}
    <form action="{% url 'challenges:delete' challenge.pk %}" method="POST">
        {% csrf_token %}
        <input type="submit" value="삭제">
    </form>
    <form action="{% url 'challenges:update' challenge.pk %}" method="GET">
        {% csrf_token %}
        <input type="submit" value="수정">
    </form>
{% endif %}
<br>
<h5>
    <p>* 참여기간: {{ challenge.start_date|date:"Y년 m월 d일" }}
    ~ {{ challenge.end_date|date:"Y년 m월 d일" }}
    {% if days_remaining >= 0 %}
    <span class="red-text">{{ d_day_string }}</span>
    {% else %}
    종료된 캠페인입니다.
    {% endif %}
    </p>    
    <p>* 모집인원 000</p>
</h5>
{% comment %} 참가/미참가 {% endcomment %}
<br>
<form class="participation-forms" action="{% url 'challenges:participation' challenge_pk=challenge.pk %}" method="POST" data-challenge-id="{{ challenge.pk }}">
  {% csrf_token %}
  <button id="participation-toggle-{{ challenge.pk }}" class="green-button" type="{% if days_remaining < 0 %}button{% else %}submit{% endif %}" {% if days_remaining < 0 %}onclick="showEndedMessage()"{% endif %}>
    {% if request.user in challenge.participants.all %}
      미참가
    {% else %}
      참가
    {% endif %}
  </button>
  <div>참여인원: <span id="participants-count">{{ challenge.participants.count }}</span>명</div>
</form>

<br>
<div id="certification_form_container" class="certification-none">
    <form action="{% url 'challenges:certification_create' challenge.pk %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ certification_form.as_p }}
        <div>
            <input type="submit" value="작성하기">
        </div>
    </form>
    <p>챌린지에 참여하신 사용자만 인증이 가능합니다.</p>
</div>

<br>
<!--인증 내용-->
{% if u_certification_forms %}
    {% for certification, u_certification_form in u_certification_forms %}
            <div class="d-wrapper certification--box">
                <div class="d-title-wrapper">
                    <p class="d-title">{{ certification.title }}</p>
                    <!--내용-->
                    <p class="d-content">{{ certification.content|linebreaksbr }}</p>
                    {% if certification.image %}
                    <img src="{{certification.image.url }}" alt="이미지">
                    {% endif %}
                </div>
                <div class="d-content-wrapper">
                    <p class="d-username">작성자 : {{ certification.user.username }}</p>
                    <p class="d-created_at">{{ certification.created_at|date:"Y-m-d" }}&nbsp;&nbsp;&nbsp;&nbsp;{{ certification.created_at|date:"H:i:s" }}</p>
                </div>
            </div>

            <!-- 수정 및 삭제 버튼 추가 -->
            {% if user == certification.user %}
            <div class="modify-delete-buttons">
                <!-- 수정 버튼 -->
                <button class="review-btn" id="certificationUpdateButton{{ certification.pk }}" type="button" onclick="toggleCertificationUpdateForm({{ certification.pk }})">수정</button>
                <form id="certificationUpdateForm{{ certification.pk }}" action="{% url 'challenges:certification_update' challenge.pk certification.pk %}" method="POST" enctype="multipart/form-data" style="display:none;">
                    {% csrf_token %}
                    {{ u_certification_form.as_p }}
                    
                    <div class="button-wrapper">
                        <button class="u-button" type="submit">수정</button>
                    </div>
                </form>

                <!-- 삭제 버튼 -->
                <form action="{% url 'challenges:certification_delete' challenge.pk certification.pk %}" method="POST">
                  {% csrf_token %}
                  <button type="submit">삭제</button>
                </form>
            </div>
        {% endif %}
    {% empty %}
    <p>게시물이 없습니다.</p>
    {% endfor %}
{% endif %}

<script>
  const participationToggleButton = document.getElementById("participation-toggle-{{ challenge.pk }}");

  participationToggleButton.addEventListener("click", function (e) {
    {% if not request.user.is_authenticated %}
      e.preventDefault(); 
      alert("로그인이 필요한 기능입니다. 로그인 페이지로 이동합니다.");
      location.href = "/accounts/login/";
    {% endif %}
  });

  function showEndedMessage() {
    alert("이미 종료된 챌린지입니다.");
  }

  function showCertification() {
    alert("이미 인증을 완료하셨습니다. 추가 인증은 불가능합니다.");
  }
</script>
<script>

function disableParticipationForm() {
  const participantBtn = document.querySelector(".green-button");
  participantBtn.setAttribute("disabled", "disabled");
  participantBtn.addEventListener("click", function () {
    alert("이미 인증을 완료하셨습니다. 추가 인증은 불가능합니다.");
  });
}

const userHasCertified = {{ user_has_certified|yesno:"true,false" }};

if (userHasCertified) {
  disableParticipationForm();
}

const participationForm = document.querySelectorAll(".participation-forms");
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
participationForm.forEach((form) => {
  form.addEventListener('submit', function (e){
    e.preventDefault();
    const challengeId = e.target.dataset.challengeId;

    axios({
      method: "POST",
      url: `/challenges/${challengeId}/participation/`,
      headers: {'X-CSRFToken': csrftoken},
    })
    .then((response) => {
      console.log(response.data)
      const isParticipating = response.data.is_participating;
      const participantBtn = document.querySelector(`#participation-toggle-${challengeId}`);
      const participantCount = document.querySelector(`#participants-count`);
      const certificationForm = document.querySelector(`#certification_form_container`)
      const isCertified = response.data.is_certified;
      console.log(isCertified)

      if (isCertified) {
        disableParticipationForm();
      } else {
        if (isParticipating) {
          participantBtn.textContent = "미참가";
          certificationForm.classList.remove('certification-none');
        } else {
          participantBtn.textContent = "참가";
          certificationForm.classList.add('certification-none');
        }
        participantCount.innerText = response.data.participants_count;
      }
    })
    .catch((error) => {
      console.log(error.response);
    });
  })
})


function toggleCertificationUpdateForm(certification_id) {
  const form = document.getElementById("certificationUpdateForm" + certification_id);
  const box = document.querySelector(".certification--box");
  const button = document.getElementById("certificationUpdateButton" + certification_id);
  
  if (form.style.display === "none") {
    form.style.display = "block";
    box.style.display = "none";
    button.innerHTML = "취소";
  } else {
    form.style.display = "none";
    box.style.display = "block";
    button.innerHTML = "리뷰 수정";
  }
}

</script>
{% endblock content %}